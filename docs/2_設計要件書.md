# NotesDB変換パイライン 設計要件書

バージョン: 1.0.0  
作成日: 2025-10-23  
対象: プロジェクト全体

## 1. 全体要件

### 1.1. 機能範囲

* 指定されたNotesDB（単一またはManifest経由で複数）から文書をDXL形式で取得する。  
* 取得したDXLを、定義されたスキーマの正規化JSON (normalized.json) に変換する。  
* DXLに含まれる添付ファイル・埋め込みオブジェクトの実体を指定ディレクトリに抽出・保存する。  
* 正規化JSONを元に、HTML, Markdown, DOCX, PDF の各ドキュメント形式を生成する。  
* 処理の進捗状況を記録し、中断・再開を可能にする。  
* 設定ファイル（プロファイル）に基づき、実行パラメータ（対象DB、出力形式、ログレベル等）を制御できる。

### 1.2. 性能・品質要件

* DXL解析: Notesリッチテキストの主要な要素（太字、斜体、下線、文字色、文字サイズ、背景色、上付き/下付き文字、リンク、テーブル（セル結合・スタイル含む）、添付参照）を runs 配列等として正確に抽出・保持すること。  
* レンダリング:  
  * normalized.json の runs 配列等に基づき、各出力形式で可能な限り忠実な書式再現を目指すこと。  
  * フォント設定（NotoSansJP系）を適切に適用し、特にPDFとHTMLで日本語表示が正しく行われること。  
  * 添付ファイルへのリンク（相対パス）が正しく機能すること（HTML/Markdown）。埋め込み（DOCX/PDF）が正しく行われること。  
* 進捗管理: 大規模DB処理（数万件規模）においても、中断・再開が確実に行えること。  
* エラーハンドリング: Notes接続エラー、DXL解析エラー、ファイルI/Oエラー等が発生した場合、適切なログを出力し、可能な限り処理を継続（または安全に停止）すること。

### 1.3. 環境要件

* 実行環境: Windows (32bit)  
* 必須ソフトウェア: HCL Notes Client (32bit), Python 3.13 (32bit)  
* 依存ライブラリ: requirements.txt に記載されたライブラリ群。

## 2. モジュール別要件

### 2.1. core.dxl.parser (DXL解析モジュール)

* 入力: DXLファイルパス、またはDXL文字列。  
* 出力: normalized.json スキーマ（v1.2および拡張仕様）に準拠したPython dictオブジェクト。  
* 機能要件:  
  * メタデータ抽出: <noteinfo>, Form, Subject 等の基本情報を meta, fields.Subject に格納する。  
  * リッチテキスト解析 (runs およびテーブル構造):  
    * <pardef>, <par>, <run>, <font>, <fontstyle>, <picture>, <attachmentref>, <doclink>, <urllink>, <table>, <tablecell> 等のDXL要素を解析する。  
    * 基本スタイル情報（太字、斜体、下線、取り消し線、等幅）を runs[].s 配列に保持する。  
    * 文字属性（色 @color、サイズ @size、背景色 @bgcolor、上付き/下付き @superscript/@subscript）を runs[].a 辞書に保持する。  
    * リンク情報 (<doclink>, <urllink>) は {"t": "link", "href": ..., "label": ..., "notes": {...}} 形式のトークンに変換し、links オブジェクトにも集約する。  
    * 添付ファイル参照 (<attachmentref>, <picture>) は {"t": "attachmentref", "name": ...} または {"t": "img", "src": ...} トークンとして保持し、attachments 配列にもメタ情報を集約する。srcには、ファイルの実体ではなく、抽出後のファイルへのアクセスを示す情報（例: $FILE:filename.ext やプレースホルダー）を格納する。  
    * テーブル (<table>) は {"t": "table", "rows": [[{"runs": [...], "colspan": N, "rowspan": M, "style": {...}}, ...], ...]} 形式のトークンに変換する。セルの結合情報 (@colspan, @rowspan) やスタイル情報（背景色、罫線等）も可能な限り抽出・保持する。  
  * 添付メタデータ: <attachmentref>, <picture>, <object type="file"> からファイル名、サイズ（推定）、参照情報 (ref) を抽出し、attachments 配列に格納する。Base64デコードはここでは行わない。  
  * エラー処理: 解析不能なDXL構造や予期せぬ要素に対して警告ログを出力し、可能な限り処理を継続する。

### 2.2. core.attachments (添付ファイル処理モジュール)

* 入力: DXLファイルパス、normalized.json の attachments メタデータリスト、出力先ディレクトリパス、normalized.json オブジェクト（パス更新用）。  
* 出力: 指定ディレクトリ配下に抽出された添付ファイル群、および相対パス情報が追記された normalized.json オブジェクト。  
* 機能要件:  
  * DXL内の <object type="file"> 要素から <filedata> (Base64) を読み込む。  
  * attachments メタデータリストと照合し、対応するファイル名でデコード・保存する。  
  * 保存先パスは <出力先ディレクトリ>/<UNID>/attachments/<ファイル名> を基本とする。  
  * ファイル名にOSで使用できない文字が含まれる場合はサニタイズ処理を行う (utils.fs.sanitize_filename)。  
  * 抽出・保存に成功したファイルについて、normalized.json オブジェクト内の対応する attachments 配列要素や runs 内の img トークン (src) に、出力ルートからの相対パス（例: attachments/image.png）を設定（更新）する。  
  * 処理結果（成功/失敗、保存パス）を呼び出し元（pipelines）に返す。  
  * Base64デコードエラーやファイル書き込みエラーが発生した場合は、エラーログを出力する。

### 2.3. core.render (レンダリングエンジン)

* 入力:  
  * normalized.json オブジェクト: core.attachments によって添付ファイル・画像への相対パス情報（例: attachments/image.png）が追記・更新された状態のPython dictオブジェクト。  
  * 出力フォーマット指定: (html, md, docx, pdf)。  
* 出力: 指定されたフォーマットのファイル。  
* データ受け渡しに関する注意点:  
  * レンダラーは、画像や添付ファイルの実体（バイナリデータ）を直接受け取らない。 ファイル抽出はレンダリング前に core.attachments によって完了しているものとする。  
  * レンダラーは、入力された normalized.json オブジェクト内の相対パス情報に基づいて、リンク生成またはファイル埋め込みを行う。  
* 機能要件:  
  * 共通 runs ハンドラ:  
    * normalized.json の Body.runs 配列（およびテーブル構造）を走査する共通ロジックを持つ。  
    * runs トークン (text, br, link, img, table, attachmentref 等) やテーブルセル情報ごとに、指定されたハンドラクラスのメソッド（例: handle_text, handle_image, handle_table_start, handle_cell_start）を呼び出すビジターパターンまたは類似の機構を実装する。handle_image や handle_attachmentref は相対パスを受け取ることを前提とする。  
  * HTML/Markdown エンジン (html.py, md.py):  
    * 共通ハンドラを用いて runs を解釈し、Jinja2テンプレートに渡すコンテキストデータを構築する。  
    * テンプレート内で、runs の各要素（拡張スタイル含む）に対応するHTMLタグまたはMarkdown記法を生成する。  
    * 画像や添付ファイル参照に対しては、JSON内の相対パスを用いて <img> タグの src や <a> タグの href を生成する。  
    * HTML出力では @font-face を適用する。  
  * DOCXエンジン (docx.py):  
    * python-docx を使用する。  
    * 共通ハンドラからのコールバックを受け、Document オブジェクトを構築する。  
    * 文字装飾（拡張スタイル含む）を適用する。  
    * テーブル生成時にセル結合やセルスタイルを適用する。  
    * 画像トークン (img) に対しては、JSON内の相対パスを使い、ファイルシステムから画像ファイルを読み込んで文書に埋め込む (add_picture())。 添付ファイル参照に対しては、ファイル名と相対パスを用いたリンクテキスト等を挿入する。  
    * utils.font で解決されたフォント名を適用する。  
  * PDFエンジン (pdf.py):  
    * reportlab を使用する。  
    * 共通ハンドラからのコールバックを受け、Flowable オブジェクトのリストを構築する。  
    * 文字装飾（拡張スタイル含む）を適用する。  
    * TableStyle を用いてテーブルのセル結合、スタイル等を設定する。  
    * 画像トークン (img) に対しては、JSON内の相対パスを使い、ファイルシステムから画像ファイルを読み込んで文書に埋め込む (Image())。 添付ファイル参照に対しては、ファイル名と相対パスを用いたリンクテキスト等を挿入する。  
    * utils.font で登録されたフォントを適用する。  
  * 付録生成: core.post.appendix を呼び出す。  
  * アクセシビリティ: (HTML) core.post.a11y を呼び出す。

### 2.4. pipelines (パイプライン制御モジュール)

* 入力: main.py から渡される実行パラメータ（DB設定、パス情報など）。  
* 出力: ログ、進捗ファイル (JSONL)、および core モジュール実行による成果物。  
* 機能要件 (pipelines/flows.py):  
  * run_unified:  
    * Unifiedモードのロジックを実行するライブラリ関数。  
    * Notes接続 → DXL取得 → JSON正規化 → 添付抽出 (JSONパス更新含む) → レンダリング を一気通貫で実行する。  
  * run_from_manifest:  
    * Manifest処理のロジックを実行するライブラリ関数。  
    * Manifest JSONに基づき、各DBに対して run_unified を呼び出す。  
  * run_decoupled_export:  
    * Decoupledモード (Export) のロジックを実行するライブラリ関数。  
    * Notes接続 → DXL取得・保存 のみ実行。  
  * 進捗管理: utils.progress_jsonl を使用し、処理状況を記録・管理。  
  * DXL保存: keep_dxl=True の場合、DXLを保存。

### 2.5. utils (共通ユーティリティ)

* progress_jsonl.py: JSONLによる進捗管理機能。  
* font.py: フォントパス解決とフォント登録機能。  
* config.py: 設定値の管理（YAML読み込み含む）。  
* fs.py: ファイルシステム操作（サニタイズ、安全な書き込み）。

## 3. 中間ファイル仕様

* normalized.json: 中間ファイル.md (Normalized JSON 技術仕様書 v1.2) を基礎とし、本要件書 2.1 および 2.2 で定義された拡張書式情報（背景色、上付き/下付き、テーブルセル結合・スタイル）および抽出後の添付ファイル・画像への相対パス情報を含むこと。スキーマバージョンは、これらの拡張を含むことを示す識別子（例: "1.5-dev"）を付与することを推奨する。

## 4. コマンドラインインターフェース (main.py)

* 唯一のエントリーポイントとして機能する。  
* プロファイル実行機能:  
  * run-profile: launch.json を解釈し、対応するサブコマンドハンドラに処理を委譲する。  
  * --profiles, --profile: プロファイル実行を起動するショートカットを提供する。  
* サブコマンド機能:  
  * run-manifest: pipelines.flows.run_from_manifest を呼び出す。  
  * run-single-db: pipelines.flows.run_unified を呼び出す。  
  * export: pipelines.flows.run_decoupled_export を呼び出す。  
  * normalize: core.dxl.parser を直接呼び出し、DXL→初期JSONの変換を実行する。  
  * extract: core.attachments を直接呼び出し、添付ファイル抽出とJSONパス更新を実行する。  
  * render: core.render.engine を直接呼び出し、JSON→各フォーマットのレンダリングを実行する。

## 5. テスト要件

* 各モジュールの単体テストを実装。  
* 主要なDXLパターン（拡張書式含む）のテストケースを用意。  
* CIでスモークテスト（縦貫）を実行。  
* ゴールデン比較 (make golden-diff) でリグレッションを検出可能にする。