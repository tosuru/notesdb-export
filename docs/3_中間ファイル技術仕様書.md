# **🧩 Normalized JSON 技術仕様書（DXL→多形式変換中間フォーマット）**

Version: 1.5-dev
対応フェーズ: Phase 2〜3
更新日: 2025-10-31 (v1.4-dev から改訂)
対象: src/core/dxl/parser.py 生成出力, src/core/attachments.py 更新出力

## **📘 1\. 概要（目的）**

normalized.json は、Lotus Notes DXL から抽出した文書データを
一貫した構造で保持する中間フォーマットです。
このフォーマットは、後続のレンダリング（HTML/MD/DOCX/PDF）や
データ転送（Box 連携・全文検索）での再利用性と安定性を確保する目的で設計されています。

### **🎯 主な目的**

| 目的 | 内容 |
| :---- | :---- |
| **DXL差異の吸収** | Notes の多様なフィールド表現・名前空間差異を正規化して統一構造へ変換 |
| **再利用性の確保** | HTML/MD/DOCX/PDF 等すべてのフォーマットが同一JSONを参照して出力 |
| **情報損失の最小化** | Notes richtext・リンク・添付・拡張書式（スタイル・セル結合・**タブ付き表・セクション・水平線**）を忠実に保持 |
| **差分・再実行耐性** | 一度生成されたJSONは再レンダリング・再変換が可能（再抽出不要） |
| **将来拡張性** | schema\_version により後方互換を保ちながら段階的に拡張可能 |

## **🧱 2\. 構造概要（スキーマ）**

{  
  "schema\_version": "1.5-dev",  
  "meta": { ... },  
  "fields": { ... },  
  "attachments": \[ ... \],  
  "links": { ... },  
  "layout": { ... }  
}

### **構造要素の概要**

| 要素 | 型 | 概要 |
| :---- | :---- | :---- |
| **schema\_version** | string | JSONスキーマの互換バージョン（例: "1.5-dev"） |
| **meta** | object | 文書のメタ情報（UNID, Form, 日時など） |
| **fields** | object | フィールドデータ（Subject, Body, その他） |
| **attachments** | array | 添付・画像など、外部ファイルメタ情報（v1.3でパス情報統合） |
| **links** | object | Notes / HTTP リンク情報（文書全体からの集約） |
| **layout** | object | 出力対象フィールドの制御用情報 |

## **🧾 3\. 各要素の詳細仕様**

### **3.1 meta — 文書メタ情報**

DXL内の や から抽出。

| キー | 型 | 説明 |
| :---- | :---- | :---- |
| **unid** | string | 文書UNID（32桁HEX） |
| **form** | string | フォーム名（Notes文書テンプレート） |
| **created** | string | 作成日時（ISO8601） |
| **modified** | string | 更新日時（ISO8601） |
| **revised** | string | 改訂日時（任意） |
| **schema\_version** | string | スキーマの内部バージョン管理用（例: "1.5-dev"） |

### **3.2 fields — フィールド構造**

Notes 文書のアイテムをキーとして格納。主要項目は "Subject" と "Body"。

"fields": {  
  "Subject": {  
    "type": "text",  
    "value": "会議議事録 (DXLサンプル)",  
    "is\_primary": true  
  },  
  "Body": {  
    "type": "richtext",  
    "text": "本文のプレーンテキスト...",  
    "runs": \[ ... \] // v1.5で拡張。テーブル・セクション構造もここに統合  
  }  
}

#### **3.2.1 Body の構造（詳細）**

| キー | 型 | 内容 |
| :---- | :---- | :---- |
| **text** | string | プレーンテキスト化した本文（全文検索・ML用） |
| **runs** | array | リッチテキスト構造（**v1.5拡張。テーブル・セクション構造も含む**） |

#### **3.2.2 runs トークン詳細（v1.5-dev仕様）**

runs 配列は、リッチテキストの構成要素（トークン）のシーケンスです。

* **t (トークン種別):**  
  * "par": **段落の開始**と属性の定義 (v1.4新設)  
  * "text": テキスト断片  
  * "br": 段落**内**の強制改行 (v1.5で定義を明確化)  
  * "link": ハイパーリンク (HTTP / Notes)  
  * "img": 埋め込み画像  
  * "table": 表  
  * "hr": **水平線 (v1.5新設)**  
  * "section": **セクション（折りたたみ等） (v1.5新設)**  
  * "attachmentref": 添付ファイル参照  
* **s (スタイル配列):**  
  * b (太字), i (斜体), u (下線), s (または strike \- 取消線), mono (等幅)  
  * DXL の style='italic strikethrough' は \["i", "s"\] にマッピングされます。  
* **a (属性オブジェクト):**  
  * "color": 文字色 (例: "\#FF0000")  
  * "size": 文字サイズ (例: "12pt")  
  * "bgcolor": 背景色 (例: "\#FFFF00")  
  * "script": 上付き/下付き (例: "super", "sub")  
  * "fx": **文字効果 (v1.4追加)**。$$\`"shadow"\`, \`"emboss"\`, \`"extrude"\`$$  
    など。  
  * "font_family": フォント名 (例: "ＭＳ Ｐゴシック") 後続のレンダリング（特にPDF）に扱いは委ねる。(v1.5新設)

#### **3.2.3 💠 runs トークン例 (v1.5-dev)**

**1\. par トークン (v1.4新設)**

段落の開始を示し、属性（揃え、インデント、行間、スタイル、リスト）を保持します。このトークン以降の text や link トークンは、次の par トークンが出現するまで、この段落に属します。

{  
  "t": "par",  
  "a": {  
    "align": "justify",  
    "leftmargin": "1.5000in",  
    "spaceafter": "1.5",  
    "parstyle": "Bullet",  
    "list": {  
      "type": "uncheck"  
    }  
  }  
}

* align: justify (DXL: full), center, right, left (default)  
* list.type: DXLの list 属性値 (bullet, number, uncheck, square, alphaupper, alphalower, romanupper, romanlower) をそのまま格納します。

**2\. text トークン (fx 拡張)**

{  
  "t": "text",  
  "text": "影とエンボス付きテキスト",  
  "s": \["b", "s"\],  
  "a": {  
    "color": "\#FF0000",  
    "script": "super",  
    "fx": \["shadow", "emboss", "super"\]  
  }  
}

**3\. br トークン (v1.5 定義明確化)**

par トークンで定義された段落**内**での強制改行 (\<br/\>) を示します。

{  
  "t": "br"  
}

**4\. link トークン (v1.5新設例)**

\<urllink\> または \<doclink\> を示します。links 配列 (3.4) への参照も持ちます。

{  
  "t": "link",  
  "href": "\[http://example.com\](http://example.com)",  
  "label": "ハイパーリンク",  
  "notes": null /\* notesリンクの場合、ここにdoclink情報が入る \*/  
}

**5\. img トークン (パス統合済み)**

{  
  "t": "img",  
  "src": "attachments/image.png", // core.attachments により設定される相対パス  
  "alt": "image.png"  
}

**6\. attachmentref トークン**

{  
  "t": "attachmentref",  
  "name": "report.xlsx",  
  "content\_path": "attachments/report.xlsx" // core.attachments により設定される相対パス  
}

**7\. hr トークン (v1.5新設)**

DXLの \<horizrule/\>（水平線）を示します。

{  
  "t": "hr"  
}

**8\. section トークン (v1.5新設)**

DXLの \<section\>（折りたたみセクション）を示します。タイトルと本文の runs を再帰的に保持します。

{  
  "t": "section",  
  "title\_runs": \[  
    {"t": "par", "a": { ... }},  
    {"t": "text", "text": "無題のセクション"}  
  \],  
  "body\_runs": \[  
    {"t": "par", "a": { ... }},  
    {"t": "text", "text": "セクション内のテキストです。"}  
  \]  
}

**9\. table トークン (v1.5改訂: 列幅定義・タブ付き表対応)**

\<table...\> 要素を表現します。

{  
  "t": "table",  
  "attributes": {  
    "rowdisplay": "tabs",  
    "widthtype": "fixedleft",  
    "refwidth": "4.3542in"  /\* (v1.5) DXLのrefwidth \*/  
  },  
  "columns": \[  /\* (v1.5) widthtypeがfixed系の場合、DXLの\<tablecolumn\>定義を格納 \*/  
    { "width": "2.6146in" },  
    { "width": "1.7396in" }  
  \],  
  "rows": \[  
    { // RowObject 1 (タブ 1\)  
      "attributes": { // \<tablerow\> タグの属性  
        "tablabel": "タブラベルと表題１"   
      },  
      "cells": \[ // CellObject の配列  
        { // Cell 1,1  
          "runs": \[   
            {"t": "par", "a": { ... }},  
            {"t": "text", "text": "ああああ"}  
          \],  
          "colspan": 1,  
          "rowspan": 1,  
          "style": { "bgcolor": "\#008080" } // (teal)  
        },  
        { // Cell 1,2 (ネストされたテーブルを含む例)  
          "runs": \[  
            {"t": "par", "a": { ... }},  
            {  
              "t": "table",  
              "attributes": { "widthtype": "fitmargins", "refwidth": "..." },  
              "columns": \[ ... \],  
              "rows": \[ ... \] // 再帰的にテーブル構造が入る  
            }  
          \],  
          "colspan": 1,  
          "rowspan": 1,  
          "style": { }  
        }  
      \]  
    },  
    { // RowObject 2 (タブ 2\)  
      "attributes": {  
        "tablabel": "タブラベルと表題２"  
      },  
      "cells": \[ ... \]  
    }  
  \]  
}

### **3.3 attachments — 添付・画像メタ情報 (v1.4改訂: アイコン共有化対応)**

Notes DXL 内の / / から抽出。

core.attachments モジュールにより、抽出・保存されたファイルへの content\_path (相対パス) が追記されます。

#### **🆕 v1.4/v1.5 仕様**

* 添付ファイルに対応する **アイコン画像 (.gif)** は個別に出力しません。  
* 各拡張子ごとに 1 つの共有アイコンを利用します (例: attachments/icons/md.gif)。  
* attachments 配列には **実体ファイル (type:"file")** および **インライン画像 (type:"image")** のみを登録します。  
* 旧仕様で存在した type:"image" (ref.element:"attachmentref") のアイコン項目は廃止しました。  
* これにより、attachmentref.content\_path は常に本体ファイルを指し、レンダラは拡張子からアイコンを決定可能となります。

"attachments": \[  
  {  
    "name": "report.xlsx",  
    "type": "file",  
    "ref": { "element": "attachmentref", "oid": "OID123" },  
    "size": 1024,  
    "content\_path": "attachments/report.xlsx", // 本体ファイルの相対パス  
    "icon\_path": "attachments/icons/xlsx.gif"   // 任意 (共有アイコン)  
  },  
  {  
    "name": "sample.png",  
    "type": "image",  
    "ref": { "element": "picture", "src": "$FILE:sample.png" },  
    "size": 5120,  
    "content\_path": "attachments/sample.png" // inline picture の相対パス  
  }  
\]

### **3.4 links — 外部リンク情報 (v1.5修正)**

文書全体から doclink と urllink を集約し、正規化して保持します。

"links": {  
  "notes": \[  
    {  
      "raw": "notes://Server/Replica/0/UNID?OpenDocument",  
      "server": "Server",  
      "replica": "Replica",  
      "unid": "UNID",  
      "query": "OpenDocument",  
      "resolved\_url": null,  
      "meta": { ... }  
    }  
  \],  
  "http": \[  
    { "raw": "\[http://example.com/path\](http://example.com/path)", "label": "ハイパーリンク", "resolved": null }  
  \]  
}

### **3.5 layout — 出力制御情報**

レンダリング時の「主要フィールド」「付録出力」を制御。(v1.2からの変更なし)

"layout": {  
  "primary\_fields\_allowlist": \[  
    "Subject", "From", "To", "CC", "Body", "Categories", "Created", "Modified"  
  \],  
  "used\_in\_body": \["Subject", "Body"\]  
}

## **🧠 4\. 設計意図・データ設計思想**

### **(1) 「情報を失わず・使いやすく」**

* Notes特有のデータ（リッチテキスト・文書リンク・埋込ファイル・**拡張書式・タブ付き表・セクション**）を**構造化**  
* 書式・表現は runs に展開（v1.5でほぼ全てのDXL要素を統合）  
* 一般的なテキスト利用では Body.text を参照

### **(2) 「多フォーマット共通の抽象層」**

* HTML/MD/DOCX/PDF がすべて同じJSON構造を参照  
* 各レンダラは runs を解釈するビジターパターンに集中

### **(3) 「再現性と将来互換」**

* スキーマは**上位互換**（Body.tables のような旧フィールドはv1.5で削除）  
* 解析時の出力は deterministic（同DXLなら同JSON）

### **(4) 「運用・再処理容易性」**

* JSON → HTML/MD/DOCX/PDF の再レンダリングが独立実行可能  
* **v1.5プロセス:** DXL → JSON (v1.5) → 添付抽出 (JSONにcontent\_path追記) → JSON → HTML/MD/etc  
* 変換ログとレポートにより**再現性の高いバッチ処理**

## **🔍 5\. スキーマバージョン履歴**

| Version | 主な変更 | 対応フェーズ |
| :---- | :---- | :---- |
| **1.0** | 基本構造確立（meta/fields/links/layout） | Phase 1 |
| **1.1** | doclink統合・メタ拡充・logs連携 | Phase 1.1 |
| **1.2** | 添付・表・runs拡張（基本スタイル）、属性（color/size） | Phase 2 |
| **1.3-dev** | runs 拡張 (背景色, 上/下付き, table, attachmentref) table 構造刷新 (セル結合・スタイル・タブ付き表 tablabel 対応) attachments / runs への content\_path (相対パス) 統合 Body.tables を非推奨 (Deprecated) に | Phase 2〜3 |
| **1.4-dev** | par トークン導入 (align, margin, list, parstyle) a.fx 属性導入 (shadow, emboss, extrude) br トークンを非推奨とし par による段落管理へ移行 | (v1.5に統合) |
| **1.5-dev** | **table トークンに refwidth, columns を追加 (列幅定義)** **hr トークン（水平線）を追加** **section トークン（セクション）を追加** par (段落開始) と br (段落内改行) の定義を明確化 text.a から font\_family を意図的に除外することを明記 Body.tables ( $$Deprecated$$ ) を完全削除 v1.4-dev の変更点をすべて統合 | Phase 2〜3 (Fix) |

## **🧩 6\. 使用例**

### **1\. DXL → JSON (正規化)**

\# DXLから v1.5-dev 形式のJSONを生成 (まだ content\_path は無い)  
python \-m src.pipelines.normalize tests/data/\*.xml \-o dist/json

### **2\. 添付抽出 & JSONパス更新 (v1.5 必須プロセス)**

\# DXLとJSONを参照し、添付ファイルを抽出し、JSON内の content\_path を更新  
python \-m src.pipelines.extract\_attachments dist/json/\*.json \--dxl-root tests/data/ \--output-dir dist/

### **3\. JSON → HTML/MD (レンダリング)**

\# content\_path が追記されたv1.5 JSONを元にHTMLを生成  
python \-m src.pipelines.render\_all dist/json/\*.json \-o dist/html \--fmt html