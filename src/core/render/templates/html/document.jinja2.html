<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ subject | e }}</title>
    <style>
        {# ========= Tokens ========= #}
        :root{
        --border:#e5e5e5; --text:#111; --muted:#666; --bg:#fff;
        --page-x: clamp(16px, 4vw, 56px);
        --page-y: 28px;
        --tab-fg:#333; --tab-bg-default:#f6f6f6; --tab-ac:#2684ff;
        --section-bg:#fafafa; --section-br:#eee;
        }

        *{box-sizing:border-box}
        html,body{margin:0;padding:0}
        body{
        color:var(--text); background:var(--bg);
        font-family:"Noto Sans JP","Segoe UI",system-ui,-apple-system,Roboto,"Hiragino Kaku Gothic ProN","Yu Gothic",Meiryo,sans-serif;
        line-height:1.6; -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
        }

        {# ========= Layout (ãƒ¯ã‚¤ãƒ‰æ¨™æº– + ååˆ†ãªã‚¬ã‚¿ãƒ¼) ========= #}
        .page{ max-width:none; margin:0 auto; padding:var(--page-y) var(--page-x); }

        {# ========= Typography ========= #}
        h1,h2,h3,h4,h5,h6{ margin:1.2rem 0 .6rem; line-height:1.25 }
        p{ margin:.5rem 0 }
        small,.muted{ color:var(--muted) }
        a{ color:inherit; word-break:break-word }

        .indent-1{ margin-left:1.5rem; border-left:3px solid var(--border); }
        .indent-2{ margin-left:2.0rem; border-left:3px solid var(--border); }
        .indent-3{ margin-left:2.5rem; border-left:3px solid var(--border); }
        
        {# ========= Lists ========= #}
        ul,ol{ margin:.4rem 0 .6rem; padding-left:1.25rem }
        li{ margin:.15rem 0 }

        {# ========= Tables ========= #}
        .table-wrap{ display:block; width:100%; overflow-x:auto; -webkit-overflow-scrolling:touch }
        .table-wrap>table{ max-width:none; table-layout:fixed }

        table{ border-collapse:collapse; width:100% }
        td,th{ border:1px solid var(--border); padding:6px; vertical-align:top }
        th{ font-weight:600; background:#fbfbfb }

        {# ========= Meta Info / Appendixï¼ˆæ—§ãƒ†ãƒ³ãƒ—ãƒ¬ã®è‰¯ã„æ‰€ã‚’å¾©æ´»ï¼‰ ========= #}
        .meta-info{ margin: .5rem 0 1rem; padding:.5rem .75rem; background:#fafafa; border:1px solid #f0f0f0; border-radius:6px }
        .meta-info strong{ display:inline-block; min-width:6.5rem; color:#333 }
        .appendix>h2{ margin-top:1.2rem }
        .appendix table thead th{ background:#f5f7fa; }
        .appendix table tbody tr:nth-child(odd){ background:#fcfcfc }

        {# ========= Tabbed Table (è¦³ç‚¹1, 2, 6 æº–æ‹ ã®åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ«) ========= #}
        {# ä¾å­˜ã‚»ãƒ¬ã‚¯ã‚¿ (tab-tg-N, tab-content-N) ã¯å‰Šé™¤ã€‚å‹•çš„CSSãŒãƒã‚¯ãƒ­å´ã§ç”Ÿæˆã•ã‚Œã‚‹ #}
        .tabbed-table{
            margin:1rem 0; border:1px solid var(--border); border-radius:8px; overflow:hidden; background:#fff
        }
        .tabbed-table .tabs{
            display:flex; gap:0;
            border-bottom: 1px solid var(--border); /* è¦³ç‚¹6 */
.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
.tabbed-table .tabs label:focus-visible{outline:2px solid var(--tab-ac); outline-offset:2px}

        }
        .tabbed-table .tabs label{
            flex:0 0 auto; padding:.55rem .9rem; cursor:pointer; user-select:none;
            background: var(--tab-bg, var(--tab-bg-default)); /* è¦³ç‚¹2 */
            color:var(--tab-fg); border-right:1px solid var(--border);
            border-bottom: 2px solid transparent; /* è¦³ç‚¹6 */
.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
.tabbed-table .tabs label:focus-visible{outline:2px solid var(--tab-ac); outline-offset:2px}

            margin-bottom: -1px; /* è¦³ç‚¹6 */
.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
.tabbed-table .tabs label:focus-visible{outline:2px solid var(--tab-ac); outline-offset:2px}

        }
        .tabbed-table .tabs label:last-child{ border-right:0 }
        .tabbed-table .panels > table{
            border-top:0; margin:0;
        }
        .tabbed-table input[type=radio]{ display:none } /* å¿µã®ãŸã‚æ®‹ã™ */

        {# ========= Section (details/summary) ========= #}
        .section-block{ border:1px solid var(--section-br); border-radius:8px; background:var(--section-bg); padding:.25rem .5rem; margin: .8rem 0 }
        .section-block>.section-title{ list-style:none; cursor:pointer; user-select:none }
        .section-block>.section-title::-webkit-details-marker{ display:none }
        .section-block>.section-title p{ margin:.25rem 0; font-weight:600 }
        .section-block[open]>.section-title{ border-bottom:1px dashed #e6e6e6; padding-bottom:.25rem; margin-bottom:.25rem }
        .section-body{ padding:.25rem .25rem }

        {# ========= Media / Code ========= #}
        img,svg,video,canvas{ max-width:100%; height:auto }
        code,pre{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Roboto Mono", monospace }
        pre{ overflow:auto; background:#fafafa; border:1px solid #f0f0f0; padding:.75rem; border-radius:6px }

        {# ========= Printï¼ˆå¿…è¦ãªã‚‰ï¼‰ ========= #}
        @media print{
        .page{ padding:12mm 12mm }
        .table-wrap{ overflow:visible }
        a{ text-decoration:none }
        }

        {# ========= è¦ªãƒªãƒ³ã‚¯ã®é€šå¸¸æ™‚ï¼šä¸‹ç·šã‚ã‚Šã€è‰²ã¯é’ç³» ========= #}
        .back-to-parent a {
            color: #3366cc;
            text-decoration: underline;
        }
        {# ========= è¦ªãƒªãƒ³ã‚¯ã®ãƒ›ãƒãƒ¼æ™‚ï¼šå¼·èª¿ ========= #}
        .back-to-parent a:hover {
            text-decoration: underline;
            color: #0044aa;
        }
    </style>
</head>
<body>
    <div class="page">
        {# --- å†å¸°ãƒã‚¯ãƒ­: ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒˆ (span, a, img, br, attachment_link) ã‚’æç”» --- #}
        {# (è¦³ç‚¹4, 5) |default([]) ã‚’ä»˜ä¸ #}
        {% macro render_content(items) -%}
            {%- for item in items | default([]) -%}
                {%- if item.type == 'span' -%}
                    <span{% if item.style %} style="{{ item.style | e }}"{% endif %}>{%- for tag in item.tags -%}<{{ tag }}>{%- endfor -%}{{- item.text | e -}}{%- for tag in item.tags | reverse -%}</{{ tag }}>{%- endfor -%}</span>
                {%- elif item.type == 'a' -%}
                    <a href="{{ item.href | e }}"
                        {# ä»»æ„å±æ€§ã‚’ã™ã¹ã¦å±•é–‹ï¼ˆä¾‹: target, rel, data-* ãªã©ï¼‰ #}
                        {% if item.attributes %}
                            {% for k, v in item.attributes.items() if v %} {{ k }}="{{ v | e }}"{% endfor %}
                        {% endif %}
                        {% if item.style %} style="{{ item.style | e }}"{% endif %}>
                        {%- for tag in item.tags %}<{{ tag }}>{% endfor -%}{{- item.label | e -}}{%- for tag in item.tags | reverse %}</{{ tag }}>{% endfor -%}
                    </a>
                {%- elif item.type == 'img' -%}
                    <img src="{{ item.src | e }}" alt="{{ item.alt | e }}">
                {%- elif item.type == 'attachment_link' -%}
                    <a href="{{ item.href | e }}"
                        class="attachment-link"
                        {# æ—¢å­˜: æ˜ç¤ºdownload #}
                        {% if item.attributes and item.attributes.download %} download="{{ item.attributes.download | e }}"{% endif %}
                        {# è¿½åŠ : download ä»¥å¤–ã®ä»»æ„å±æ€§ã‚’å±•é–‹ï¼ˆä¾‹: target, relï¼‰ #}
                        {% if item.attributes %}
                        {% for k, v in item.attributes.items() if v and k != 'download' %} {{ k }}="{{ v | e }}"{% endfor %}
                        {% endif %}
                        {% if item.style %} style="{{ item.style | e }}"{% endif %}>
                        <img src="{{ item.icon_src | e }}" alt="icon" class="attachment-icon"><br>{{- item.label | e -}}
                    </a>
                {%- elif item.type == 'br' -%}
                    <br>
                {%- endif -%}
            {%- endfor -%}
        {%- endmacro %}

        {# --- å†å¸°ãƒã‚¯ãƒ­: ãƒ–ãƒ­ãƒƒã‚¯ (p, list, table, section, hr) ã‚’æç”» --- #}
        {# (è¦³ç‚¹4, 5) |default([]) ã‚’ä»˜ä¸ #}
        {% macro render_blocks(blocks) -%}
            {%- for block in blocks | default([]) -%}
                {%- if block.type == 'p' -%}
                    <p{% if block.attributes.class %} class="{{ block.attributes.class | e }}"{% endif %}{% if block.style %} style="{{ block.style | e }}"{% endif %}>{{- render_content(block.content | default([])) -}}</p>
                {%- elif block.type == 'list' -%}
                    {# (è¦³ç‚¹4) block.items -> block['items'] ã«å¤‰æ›´ #}
                    <{{ block.tag }} style="{{ block.style | e }}" {% if block.attributes.type %}type="{{ block.attributes.type }}"{% endif %}>
                        {%- for item in block['items'] | default([]) -%}
                            <li{% if item.attributes and item.attributes.class %} class="{{ item.attributes.class | e }}"{% endif %}{% if item.style %} style="{{ item.style | e }}"{% endif %}>{{- render_content(item.content | default([])) -}}</li>
                        {%- endfor -%}
                    </{{ block.tag }}>
                {%- elif block.type == 'section' -%}
                    <details class="section-block"{% if block.style %} style="{{ block.style | e }}"{% endif %}>
                        <summary class="section-title">{{- render_blocks(block.title_blocks | default([])) -}}</summary>
                        <div class="section-body">{{- render_blocks(block.body_blocks | default([])) -}}</div>
                    </details>
                {# --- [è¦³ç‚¹ 1, 2, 3, 4, 5, 6, 7] å…¨é¢æ”¹è¨‚ç‰ˆã‚¿ãƒ–ãƒ†ãƒ¼ãƒ–ãƒ« --- #}
                {%- elif block.type == 'table' -%}
                    {%- if block.attributes and block.attributes.rowdisplay == "tabs" and block.tab_group_id -%}
                        
                        {# --- 2. HTMLæ§‹é€  (è¦³ç‚¹1) --- #}
                        <div class="table-wrap"><div class="tabbed-table">

                            {# --- 1. å‹•çš„CSSã®ç”Ÿæˆ (è¦³ç‚¹1, 6, 7) [â˜…ä¿®æ­£ï¼štabbed-tableã®å†…å´ã«ç§»å‹•] --- #}
                            <style>
                            {%- for row in block.rows | default([]) -%}
                            /* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–ã®ã‚¹ã‚¿ã‚¤ãƒ« */
                            #tab-{{ block.tab_group_id }}-{{ loop.index }}:checked ~ .tabs label[for="tab-{{ block.tab_group_id }}-{{ loop.index }}"] {
                                border-bottom: 6px solid var(--tab-ac);
                                font-weight: bold;
                                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
                            }
                            /* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ‘ãƒãƒ«ã®è¡¨ç¤º */
                            #tab-{{ block.tab_group_id }}-{{ loop.index }}:checked ~ .panels .panel-{{ block.tab_group_id }}-{{ loop.index }} {
                                display: table;
                                border-collapse: collapse; /* è¦³ç‚¹6 */
.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
.tabbed-table .tabs label:focus-visible{outline:2px solid var(--tab-ac); outline-offset:2px}

                            }
                            {%- endfor -%}
                            /* ãƒ‘ãƒãƒ«ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆéè¡¨ç¤º */
                            .tabbed-table .panels > table {
                                display: none;
                            }
                            </style>
                        
                            {# 2a. Inputs (éè¡¨ç¤º) #}
                            {# 2a. Inputsï¼ˆãƒ©ãƒƒãƒ‘ãƒ¼ãªã—ï¼š.tabbed-table ç›´ä¸‹ã«é…ç½®ï¼‰ #}
                            {%- for row in block.rows | default([]) -%}
                            <input type="radio"
                                class="sr-only"
                                name="tab-group-{{ block.tab_group_id }}"
                                id="tab-{{ block.tab_group_id }}-{{ loop.index }}"
                                {% if loop.first %}checked aria-checked="true"{% else %}aria-checked="false"{% endif %}>
                            {%- endfor -%}

                            
                            {# 2b. Tabs (ãƒ©ãƒ™ãƒ«) (è¦³ç‚¹2, 6) #}
                            <div class="tabs" role="tablist">
                            {%- for row in block.rows | default([]) -%}
                            {# (è¦³ç‚¹2) æœ€åˆã®ã‚»ãƒ«ã®bgcolorã‚’å–å¾—ã€ãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ (UndefinedError å¯¾ç­–) #}
                            {% set _s = row.cells[0].attributes.style | default('') %}
                            {% set row_bg = 'var(--tab-bg-default)' %}
                            {% if 'background-color' in _s %}
                            {% set _after = (_s.split('background-color:')[1] | default('')) %}
                            {% set _semi  = (_after.split(';')[0] | default(_after)) %}
                            {% set row_bg = _semi | trim %}
                            {% endif %}
                            <label for="tab-{{ block.tab_group_id }}-{{ loop.index }}" id="tablabel-{{ block.tab_group_id }}-{{ loop.index }}" role="tab" aria-controls="panel-{{ block.tab_group_id }}-{{ loop.index }}" {% if loop.first %}aria-selected="true"{% endif %} tabindex="0" style="--tab-bg: {{ row_bg | e }};">
                                {{ row.label | e | default('Tab ' ~ loop.index) }}
                            </label>
                            {%- endfor -%}
                            </div>
                            
                            {# 2c. Panels (ãƒ†ãƒ¼ãƒ–ãƒ«æœ¬ä½“) (è¦³ç‚¹3, 4, 5) #}
                            <div class="panels">
                            {%- for row in block.rows | default([]) -%}
                            <table class="panel-{{ block.tab_group_id }}-{{ loop.index }}" id="panel-{{ block.tab_group_id }}-{{ loop.index }}" role="tabpanel" aria-labelledby="tablabel-{{ block.tab_group_id }}-{{ loop.index }}"{% if block.style %} style="{{ block.style | e }}"{% endif %}>
                                {%- if block.columns -%}
                                <colgroup>
                                    {%- for col in block.columns | default([]) -%}
                                    <col style="width: {{ col.width | e }};">
                                    {%- endfor -%}
                                </colgroup>
                                {%- endif -%}
                                <tbody>
                                    <tr {% if row.label %}title="{{ row.label | e }}"{% endif %}>
                                        {%- for cell in row.cells | default([]) -%}
                                        {# â˜…â˜…â˜… ä¿®æ­£ (è¦³ç‚¹3, 4, 5): html.py ã® 'attributes' è¾æ›¸ã‚’ç›´æ¥å‚ç…§ã™ã‚‹ â˜…â˜…â˜… #}
                                        <td
                                        {%- if cell.attributes.colspan %} colspan="{{ cell.attributes.colspan | e }}"{% endif %}
                                        {%- if cell.attributes.rowspan %} rowspan="{{ cell.attributes.rowspan | e }}"{% endif %}
                                        {%- if cell.attributes.style %} style="{{ cell.attributes.style | e }}"{% endif %}
                                        >
                                            {# (è¦³ç‚¹5) ãƒã‚¹ãƒˆã•ã‚ŒãŸãƒ–ãƒ­ãƒƒã‚¯ã®å†å¸°æç”» #}
                                            {# â˜…â˜…â˜… ä¿®æ­£ (è¦³ç‚¹1): html.py ã® 'content_blocks' ã‚’å‚ç…§ã™ã‚‹ â˜…â˜…â˜… #}
                                            {{- render_blocks(cell.content_blocks | default([])) -}}
                                        </td>
                                        {%- endfor -%}
                                    </tr>
                                </tbody>
                            </table>
                            {%- endfor -%}
                            </div><!-- /.panels -->
                        </div><!-- /.tabbed-table --></div><!-- /.table-wrap -->
                    
                    {# --- é€šå¸¸ã®è¡¨ (è¦³ç‚¹3, 4, 5) --- #}
                    {%- else -%}
                    <div class="table-wrap">
                        <table style="{{ block.style | e }}">
                            {%- if block.columns -%}
                            <colgroup>
                                {%- for col in block.columns | default([]) -%}
                                <col style="width: {{ col.width | e }};">
                                {%- endfor -%}
                            </colgroup>
                            {%- endif -%}
                            <tbody>
                                {%- for row in block.rows | default([]) -%}
                                <tr {% if row.label %}title="{{ row.label | e }}"{% endif %}>
                                    {%- for cell in row.cells | default([]) -%}
                                    {# â˜…â˜…â˜… ä¿®æ­£ (è¦³ç‚¹3, 4, 5): html.py ã® 'attributes' è¾æ›¸ã‚’ç›´æ¥å‚ç…§ã™ã‚‹ â˜…â˜…â˜… #}
                                    <td
                                    {%- if cell.attributes.colspan %} colspan="{{ cell.attributes.colspan | e }}"{% endif %}
                                    {%- if cell.attributes.rowspan %} rowspan="{{ cell.attributes.rowspan | e }}"{% endif %}
                                    {%- if cell.attributes.style %} style="{{ cell.attributes.style | e }}"{% endif %}
                                    >
                                        {# (è¦³ç‚¹5) ãƒã‚¹ãƒˆã•ã‚ŒãŸãƒ–ãƒ­ãƒƒã‚¯ã®å†å¸°æç”» #}
                                        {# â˜…â˜…â˜… ä¿®æ­£ (è¦³ç‚¹1): html.py ã® 'content_blocks' ã‚’å‚ç…§ã™ã‚‹ â˜…â˜…â˜… #}
                                        {{- render_blocks(cell.content_blocks | default([])) -}}
                                    </td>
                                    {%- endfor -%}
                                </tr>
                                {%- endfor -%}
                            </tbody>
                        </table>
                        </div>
                    {%- endif -%}
                {# --- [v1.5æ–°è¨­] hr (æ°´å¹³ç·š) --- #}
                {%- elif block.type == 'hr' -%}
                    <hr style="{{ block.style | e }}">
                {%- endif -%}
            {%- endfor -%}
        {%- endmacro %}


        <!-- 1. ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <h1>{{ subject | e }}</h1>
        
        <div class="back-to-parent" style="margin: 8px 0; font-size: 0.9em;"> ğŸ“‚ <a href="../" target="_self"> [è¦ªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª]</a></div>
        <div class="meta-info">
            <strong>UNID:</strong> {{ meta.unid | e }}<br>
            <strong>Form:</strong> {{ meta.form | e }}<br>
            <strong>Created:</strong> {{ meta.created | e }}<br>
            <strong>Modified:</strong> {{ meta.modified | e }}
        </div>
        
        <!-- 2. æœ¬æ–‡ (ãƒã‚¯ãƒ­å‘¼ã³å‡ºã—) -->
        <h2>æœ¬æ–‡</h2>
        <div class="document-body">{{- render_blocks(body_elements) -}}</div>

        <!-- 3. ä»˜éŒ² -->
        {% if appendix_rows -%}
        <div class="appendix">
            <h2>ä»˜éŒ²ï¼šãã®ä»–ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰</h2>
            <table>
                <thead>
                    <tr>
                        <th>ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å</th>
                        <th>å‹</th>
                        <th>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</th>
                    </tr>
                </thead>
                <tbody>
                    {%- for row in appendix_rows -%}
                    <tr>
                        <td>{{ row.name | e }}</td>
                        <td>{{ row.type | e }}</td>
                        <td>{{ row.preview | e }}</td>
                    </tr>
                    {%- endfor -%}
                </tbody>
            </table>
        </div>
        {%- endif %}
</div><!-- /.page -->
</body>
</html>